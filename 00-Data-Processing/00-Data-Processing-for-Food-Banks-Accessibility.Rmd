---
title: "00-Data-Processing-for-Food-Banks-Accessibility"
---

## Introduction

In this notebook we create some examples of processing the data for the analysis of accessibility to food banks in Hamilton.

## Preliminaries

Clear environment:
```{r}
rm(list = ls())
```

Load packages used in the notebook:
```{r message = FALSE}
library(cancensus)
#library(disk.frame)
#library(pycno)
library(readr)
#library(r5r) # the r5r package requires Java Development Kit version 11, which can be downloaded from https://www.oracle.com/java/technologies/javase-jdk11-downloads.html
library(sf)
library(smoothr)
library(tidyverse)
library(tmap)
library(tmaptools)
```

Data used in this notebook was retrieved from three sources: Open Hamilton, Transportation Tomorrow Survey, and the 2016 Canadian Census. Open Hamilton is an online repository of data from the City of Hamilton. The provenance of the datasets is below.

## Provenance of data: 

### Hamilton CMA boundaries

Statistics Canada. Load:
```{r}
load("input-data-files/hamilton_cma.RData")
#load("input-data-files/hamilton_da_2016.RData")
```

### Hamilton Ward boundaries

Open Data Hamilton. Read:
```{r}
wards <- st_read("input-data-files/Ward_Boundaries.shp")
```

Add label for type of ward (the urban/suburban/rural classification is by the planning teams; see https://www.hamilton.ca/develop-property/planning-applications/development-applications-mapping)
```{r}
wards$Type <- c("Urban",
                "Urban",
                "Urban",
                "Urban",
                "Urban",
                "Suburban",
                "Suburban",
                "Suburban",
                "Suburban",
                "Suburban",
                "Suburban",
                "Suburban",
                "Suburban",
                "Suburban",
                "Suburban")
```

Merge boundaries by type:
```{r}
wards <- wards %>% 
  group_by(Type) %>%
  summarize()
```

```{r}
ggplot(wards) + 
  geom_sf(aes(fill = Type))
```

Read rural boundary:
```{r}
rural <- st_read("input-data-files/Rural_Boundary.shp")
rural <- rural %>%
  transmute(Type = "Rural")
```

Plot rural boundary:
```{r}
ggplot(rural) +
  geom_sf()
```

Obtain difference between urban and suburban regions and rural boundary:
```{r}
st_difference(wards, rural) %>%
  ggplot() +
  geom_sf(aes(fill = Type))
```

Notice the detritus after the difference. Drop crumbs to obtain a cleaner version of the boundaries:
```{r}
sub_urban <- st_difference(wards, rural) %>%
  transmute(Type) %>%
  smoothr::drop_crumbs(threshold = 5000)

ggplot(sub_urban) +
  geom_sf(aes(fill = Type))
```

Bind the boundaries with all three urban types:
```{r}
urban_types <- rbind(sub_urban,
                     rural)

ggplot(urban_types) +
  geom_sf(aes(fill = Type))
```

### Location of food banks

Read file with locations:
```{r}
foodbank_locations <- read_csv("input-data-files/foodbanks-hamilton.csv",
                               col_types = cols(ID = col_double(),
                                    NAME = col_character(),
                                    TYPE = col_character(),
                                    ADDRESS = col_character(),
                                    COVIDClose = col_double(),
                                    latitude = col_double(),
                                    longitude = col_double(),
                                    name = col_character(),
                                    desc = col_character(),
                                    source = col_character(),
                                    precision = col_character()
                               ))
```

COVIDClose is an indicator variable for whether this bank closed during the pandemic. Convert to factor:
```{r}
foodbank_locations <- foodbank_locations %>%
  mutate(COVIDClose = replace_na(COVIDClose, 0),
         COVIDClose = factor(COVIDClose,
                             levels = c(0, 1),
                             labels = c("No", "Yes")))
```


Convert to simple features:
```{r}
foodbank_locations <- foodbank_locations %>%
  st_as_sf(coords = c("longitude", "latitude"), 
           crs = 4326) %>%
  st_transform(crs = 26917)
```

Map location of foodbanks:
```{r}
ggplot() +
  geom_sf(data = hamilton_cma) +
  geom_sf(data = foodbank_locations,
          aes(shape = COVIDClose,
              color = COVIDClose))
```

### `dwelling_network_points_2016.RData` 

This is based on parcel-level data, approximated to the nearest point on the road network. For processing details, see:

https://github.com/paezha/Accessibility-to-Schools-Hamilton-Equity

```{r}
load("input-data-files/dwelling_network_points_2016.RData")
```

### Census data

We can get an API key to use `cancensus` from [CensusMapper](https://censusmapper.ca/). Once you have an API key, it can be stored locally this way:
```{r eval=FALSE}
set_api_key("your-key", install = TRUE)
```

Once you have your API you can use `cancensus` like in this example.

Use `cancensus` to check and download census data. Check the regions:
```{r}
list_census_regions('CA16') %>% 
  dplyr::filter(level == "CMA", name %in% c("Hamilton"))
```

We need PR_UID 35.

List census data sets:
```{r}
list_census_datasets()
```

We need CA16.

Search variables:
```{r}
find_census_vectors("income", 
                    dataset = "CA16", 
                    type = "total", 
                    query_type = "keyword", 
                    interactive = FALSE)
```

We need v_CA16_2406 to v_CA16_2425: these are the number of households at certain levels of total income. Retrieve data:
```{r}
data_da_2016 <- get_census(dataset='CA16', 
                          regions=list(CMA=c("35537")),
                          vectors=c("v_CA16_2406",
                                    "v_CA16_2407",
                                    "v_CA16_2408",
                                    "v_CA16_2409",
                                    "v_CA16_2410",
                                    "v_CA16_2411",
                                    "v_CA16_2412",
                                    "v_CA16_2413",
                                    "v_CA16_2414",
                                    "v_CA16_2415",
                                    "v_CA16_2416",
                                    "v_CA16_2417",
                                    "v_CA16_2418",
                                    "v_CA16_2419",
                                    "v_CA16_2420",
                                    "v_CA16_2421",
                                    "v_CA16_2422",
                                    "v_CA16_2423",
                                    "v_CA16_2424",
                                    "v_CA16_2425",
                                    "v_CA16_2426"),
                          level='DA', 
                          use_cache = FALSE,
                          geo_format = "sf")
```

Plot population:
```{r}
tmap_mode(mode = "view")

data_da_2016 %>%
  mutate(income_less40k = (`v_CA16_2406: Under $5,000` + 
                             `v_CA16_2407: $5,000 to $9,999` + 
                             `v_CA16_2408: $10,000 to $14,999` +
                             `v_CA16_2409: $15,000 to $19,999` +
                             `v_CA16_2410: $20,000 to $24,999` +  
                             `v_CA16_2411: $25,000 to $29,999` +
                             `v_CA16_2412: $30,000 to $34,999` +
                             `v_CA16_2413: $35,000 to $39,999`)) %>%
  tm_shape() +
  tm_polygons("income_less40k",
              alpha = 0.8)
```

### Transportation Tomorrow Survey

I downloaded a cross-tabulation of travel mode by household income by traffic analysis zone. Read the shape file with the traffic analysis zone boundaries:
```{r}
tts_taz <- st_read("input-data-files/tts2016_2006zn_2018_region.shp")
```

Filter Hamilton (region 6):
```{r}
tts_taz <- tts_taz %>%
  dplyr::filter(region == 6)

ggplot() +
  geom_sf(data = tts_taz)
```

Read transportation data:
```{r}
travel_modes <- read_csv("input-data-files/ttsCross70628.csv",
                         col_types = cols(gta06_hhld = col_double(),
                                          income = col_double(),
                                          total = col_double(),
                                          Mode = col_character()
                                          ))
```


Code | Income
-- | --
1	| \$0 to $14999
2	| \$15000 to $39999
3	| \$40000 to $59999
4	| \$60000 to $99999
5	| \$100000 to $124999
6	| \$125000 and above
7	Decline / don't know

Filter modes:
```{r}
travel_modes <- travel_modes %>%
  dplyr::filter(Mode == "Auto driver" |
                  Mode == "Transit (Excluding GO rail)" |
                  Mode == "Walk")
```

THE NEXT NEEDS TO BE CHANGED TO DO THE ANALYSIS BY INCOME GROUP, NOT BY AGE GROUP

### Income less than $40,000

Filter age:
```{r}
travel_modes_1 <- travel_modes %>%
  dplyr::filter(income >= 1 & income <= 2)
```

Summarize trips by mode by traffic analysis zone:
```{r}
travel_modes_1 <- travel_modes_1 %>%
  group_by(gta06_hhld, Mode) %>%
  summarize(trips = sum(total),
            .groups = "drop")
```

Pivot wider and rename columns:
```{r}
travel_modes_1 <- travel_modes_1 %>%
  rename(TAZUID = gta06_hhld) %>%
  pivot_wider(names_from = Mode,
              values_from = trips,
              values_fill = 0) %>%
  rename(Driver = `Auto driver`, 
         Transit = `Transit (Excluding GO rail)`)
```

Join geometry:
```{r}
travel_modes_1 <- tts_taz %>%
  dplyr::transmute(TAZUID = gta06, geometry) %>%
  left_join(travel_modes_1,
            by = "TAZUID") %>%
  st_as_sf()
```

Plot trips as driver:
```{r}
ggplot() +
  geom_sf(data = travel_modes_1,
          aes(fill = Driver))
```

Plot trips transit:
```{r}
ggplot() +
  geom_sf(data = travel_modes_1,
          aes(fill = Transit))
```

Plot walking trips:
```{r}
ggplot() +
  geom_sf(data = travel_modes_1,
          aes(fill = Walk))
```

Rename table:
```{r}
modes_less40k <- travel_modes_1
```

Ensure that parcel ids are unique:
```{r}
dwelling_network_points_2016 <- dwelling_network_points_2016 %>% distinct(ID, .keep_all = TRUE)
```

## Save data to disk

Save data files:
```{r}
save(data_da_2016, file = "output-data-files/data_da_2016.RData", compress = "xz")
save(dwelling_network_points_2016, file = "output-data-files/dwelling_network_points_2016.RData", compress = "xz")
save(hamilton_cma, file = "output-data-files/hamilton_cma.RData", compress = "xz")
save(modes_less40k, file = "output-data-files/modes_less40k.RData", compress = "xz")
save(foodbank_locations, file = "output-data-files/foodbank_locations.RData", compress = "xz")
save(urban_types, file = "output-data-files/urban_types.RData", compress = "xz")
```

Copy files to folder `data` of the package.
