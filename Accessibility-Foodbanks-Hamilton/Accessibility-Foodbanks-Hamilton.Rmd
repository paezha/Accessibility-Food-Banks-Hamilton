---
title: "Changes in accessibility to food banks during COVID-19 and implications for the food security of vulnerable populations in Hamilton, Ontario"
author:
  - name: Author One
    email: author1@example.com
    affiliation: Some University
    footnote: 1
  - name: Author Two
    email: author2@example.com
    affiliation: 
  - name: Author Three
    email: author3@example.com
    affiliation: Some University
    footnote: 2 
  - name: Author Four
    email: author4@example.com
    affiliation: Another University
    footnote: 2
address:
  - code: Some University
    address: Department, Street, City, State, Zip
  - code: Another University
    address: Department, Street, City, State, Zip
footnote:
  - code: 1
    text: "Corresponding Author"
  - code: 2
    text: "Equal contribution"
abstract: |
  This is the abstract.

  It consists of two paragraphs.

journal: "An awesome journal"
date: "`r Sys.Date()`"
bibliography: references.bib
#linenumbers: true
#numbersections: true
csl: elsevier-harvard.csl
output: rticles::elsevier_article
header-includes:
    - \usepackage[table]{xcolor}
---

# CRediT author statement

**Author 1:** Conceptualization, Methodology, Software, Validation, Formal analysis, Investigation, Data Curation, Writing - Original Draft, Visualization, Supervision; **Author 2:** Conceptualization, Methodology, Software, Validation, Formal analysis, Investigation, Data Curation, Writing - Original Draft, Visualization; **Author 3:** Conceptualization, Investigation, Data Curation, Writing - Original Draft; **Author 4:** Resources - Writing: Review & Editing - Supervision 

```{r, setup, include=FALSE}
knitr::opts_chunk$set(
  cache = TRUE, out.width = "100%", align = 'center', fig.width = 6, fig.height = 6
)
```

```{r install-data-package, include = FALSE}
# Run only once if needed to install data package `sobiEquity`
if (!require("foodbanksHamilton", character.only = TRUE)) {
      devtools::install_github("https://github.com/paezha/Accessibility-Food-Banks-Hamilton", subdir = "foodbanksHamilton")
  }
```

```{r load-packages, cache=FALSE, include=FALSE}
library(foodbanksHamilton) # Data package
library(kableExtra)
library(patchwork)
library(sf)
library(tidyverse)
#library(tmap)
```

```{r invoke-data, include=FALSE}
data(data_da_2016)
data(dwelling_network_points_2016)
data(foodbank_locations)
data(foodbank_table)
data(hamilton_cma)
data(modes_less40k)
data(population_age_income)
data(ttm_car)
data(ttm_transit)
data(ttm_walk)
```

```{r remove-irrelevant-destinations, include=FALSE}
## Data preparation
# Remove entries in travel time matrices for inapplicable destinations
# As a first step, we will remove the computed travel times to the three Community Kitchen locations (IDs 1-3):
ttm_car <- ttm_car %>%
  filter(!between(OBJECTID, left = 1, right = 3))

ttm_transit <- ttm_transit %>%
  filter(!between(OBJECTID, left = 1, right = 3))

ttm_walk <- ttm_walk %>%
  filter(!between(OBJECTID, left = 1, right = 3))
```

```{r join-low-income-households, include=FALSE}
## Data preparation
# Join proportion of low income households per DA to dwellings and total number of residential units:
dwelling_network_points_2016 <- dwelling_network_points_2016 %>%
  left_join(data_da_2016 %>%
              st_drop_geometry() %>%
              dplyr::transmute(DAUID = GeoUID, 
                               p_inc_less40k),
            by = "DAUID")
```

```{r probability-of-low-income-per-parcel, include=FALSE}
## Data preparation
# Calculate probability that a point on the network will have low income households. This is the proportion of low income households in the DA multiplied by the total number of residential units at the point:
dwelling_network_points_2016 <- dwelling_network_points_2016 %>%
  mutate(income_less40k = p_inc_less40k * Dwellings)
```

```{r number-of-residential-units-per-DA, include=FALSE}
## Data preparation
# Prepare and join population data from Transportation Tomorrow Survey
# Find number of residential units in each DA. This is needed to assign the population to parcels
residential_units <- dwelling_network_points_2016 %>%
  st_drop_geometry() %>%
  group_by(TAZUID) %>%
  summarize(residential_units = sum(Dwellings))
```

```{r join-population-to-parcels, include=FALSE}
## Data preparation
# Join number of low income households per DA to dwellings and total number of residential units:
dwelling_network_points_2016 <- dwelling_network_points_2016 %>%
  left_join(population_age_income %>%
              st_drop_geometry() %>%
              dplyr::transmute(TAZUID,
                               children,
                               adults,
                               seniors),
            by = "TAZUID") %>%
  left_join(residential_units,
            by = "TAZUID")
```

```{r calculate-low-income-households-per-parcel, include=FALSE}
## Data preparation
# Calculate population per point on the network. This is the population in the DA divided by the total number of residential units. This gives the average number of people per residential unit. Then, multiply by the number of dwellings (residential units) at the point:
dwelling_network_points_2016 <- dwelling_network_points_2016 %>%
  mutate(children = (children/residential_units) * Dwellings,
         adults = (adults/residential_units) * Dwellings,
         seniors = (seniors/residential_units) * Dwellings)
```

```{r join-household-data-to-travel-time-tables, include=FALSE}
## Data preparation
# Join the household data to the travel time matrices:
ttm_car <- ttm_car %>%
  left_join(dwelling_network_points_2016 %>%
              st_drop_geometry() %>%
              dplyr::select(ID, 
                            income_less40k,
                            children,
                            adults,
                            seniors,
                            DAUID, 
                            TAZUID),
            by = c("UID" = "ID"))

ttm_transit <- ttm_transit %>%
  left_join(dwelling_network_points_2016 %>%
              st_drop_geometry() %>%
              dplyr::select(ID, 
                            income_less40k,
                            children,
                            adults,
                            seniors,
                            DAUID, 
                            TAZUID),
            by = c("UID" = "ID"))

ttm_walk <- ttm_walk %>%
  left_join(dwelling_network_points_2016 %>%
              st_drop_geometry() %>%
              dplyr::select(ID, 
                            income_less40k,
                            children,
                            adults,
                            seniors,
                            DAUID, 
                            TAZUID),
            by = c("UID" = "ID"))
```

```{r join-foodbank-data-to-travel-time-tables, include=FALSE}
## Data preparation
# Join the foodbank data to the travel time tables:
ttm_car <- ttm_car %>%
  left_join(foodbank_locations %>%
              st_drop_geometry() %>%
              dplyr::select(ID, 
                            TYPE,
                            COVIDClose),
            by = c("OBJECTID" = "ID"))

ttm_transit <- ttm_transit %>%
  left_join(foodbank_locations %>%
              st_drop_geometry() %>%
              dplyr::select(ID, 
                            TYPE,
                            COVIDClose),
            by = c("OBJECTID" = "ID"))

ttm_walk <- ttm_walk %>%
  left_join(foodbank_locations %>%
              st_drop_geometry() %>%
              dplyr::select(ID,
                            TYPE,
                            COVIDClose),
            by = c("OBJECTID" = "ID"))
```

```{r drop-nas-from-travel-time-tables, include=FALSE}
## Data preparation
# Drop NAs:
ttm_car <- ttm_car %>%
  drop_na(TAZUID,
          income_less40k)

ttm_transit <- ttm_transit %>%
  drop_na(TAZUID,
          income_less40k)

ttm_walk <- ttm_walk %>%
  drop_na(TAZUID,
          income_less40k)
```

```{r proportion-of-trips-by-mode-by-taz, include=FALSE}
## Data preparation
# Calculate proportion of trips by mode per TAZ:
modes <- modes_less40k %>%
  mutate(p_car = Driver/(Driver + Transit + Walk),
         p_transit = Transit/(Driver + Transit + Walk),
         p_walk = Walk/(Driver + Transit + Walk))
```

```{r fill-nas-transport-modes, include=FALSE}
## Data preparation
# Assume that TAZ with NAs have a proportion of car trips of one:
modes <- modes %>%
  dplyr::mutate(p_car = replace_na(p_car, 1),
                p_transit = replace_na(p_transit, 0),
                p_walk = replace_na(p_walk, 0))
```

```{r join-trips-by-mode-to-travel-time-tables, include=FALSE}
## Data preparation
# Join trip-making modal proportions
ttm_car <- ttm_car %>%
  left_join(modes %>%
              st_drop_geometry() %>%
              transmute(TAZUID,
                        p_car,
                        p_transit,
                        p_walk),
            by = "TAZUID")

ttm_transit <- ttm_transit %>%
  left_join(modes %>%
              st_drop_geometry() %>%
              transmute(TAZUID,
                        p_car,
                        p_transit,
                        p_walk),
            by = "TAZUID")

ttm_walk <- ttm_walk %>%
  left_join(modes %>%
              st_drop_geometry() %>%
              transmute(TAZUID,
                        p_car,
                        p_transit,
                        p_walk),
            by = "TAZUID")
```

```{r join-travel-time-tables, include=FALSE}
## Data preparation
# Join Tables into Single TTM
ttm <- ttm_car %>%
  rename(travel_time_car = travel_time) %>%
  full_join(ttm_transit %>%
              transmute(UID,
                        OBJECTID,
                        travel_time_transit = travel_time),
            by = c("UID", "OBJECTID")) %>%
  full_join(ttm_walk %>%
              transmute(UID,
                        OBJECTID,
                        travel_time_walk = travel_time),
            by = c("UID", "OBJECTID"))
```

```{r travel-time-tables-data-check, include=FALSE}
## Data preparation
# Check the NAs in travel time table:
ttm %>% 
  filter(is.na(travel_time_transit)) %>%
  select(travel_time_transit,
         p_transit) %>%
  summary()

# What do NAs here mean? Most DAs missing travel time by transit do not report trips by transit in the TTS. In some DAs there are trips by transit (p_transit != 0), but no foodbank can be reached by transit (travel_time_transit is NA). How many of these cases?
ttm %>% 
  filter(is.na(travel_time_transit) & p_transit > 0) %>%
  select(travel_time_transit,
         p_transit) %>%
  summary()

# It should be fine to replace the NAs with zeros, which multiplied by p_transit will return a zero (i.e., it is not possible to reach a foodbank by transit).
ttm <- ttm %>% 
  mutate(travel_time_transit = replace_na(travel_time_transit, 0))

# Check the NAs in travel time by walk:
ttm %>% 
  filter(is.na(travel_time_walk)) %>%
  select(travel_time_walk,
         p_walk) %>%
  summary()

# Most DAs missing travel time by walking do not report trips by walking in the TTS. In some DAs there are trips by walking (p_walk != 0), but no foodbank can be reached by walk (travel_time_walk is NA). How many of these cases?
ttm %>% 
  filter(is.na(travel_time_walk) & p_walk > 0) %>%
  select(travel_time_walk,
         p_walk) %>%
  summary()

# Like with transit, it should be fine to replace the NAs with zeros, which multiplied by p_walk will return a zero (i.e., it is not possible to reach a foodbank by walking).
ttm <- ttm %>% 
  mutate(travel_time_walk = replace_na(travel_time_walk, 0))

#Summary of the table after these operations:
summary(ttm)
```

```{r calculate-expected-travel-times, include=FALSE}
## Data preparation
# Calculate expected travel times by mode. These are the travel time by the mode multiplied by the probability of using the mode (which is proxied by the proportion of trips by mode in the DA from the TTS). The total expected travel time is the sum of the expected travel times by mode:
ttm <- ttm %>%
  mutate(e_travel_time_car = travel_time_car * p_car,
         e_travel_time_transit = travel_time_transit * p_transit,
         e_travel_time_walk = travel_time_walk * p_walk,
         e_travel_time = e_travel_time_car + e_travel_time_transit + e_travel_time_walk)
```

\newpage

Introduction
==========================

Food insecurity is defined as an "inadequate or uncertain access to a sufficient quantity and/or adequate quality of food" due to a household's financial limitations [@enns2020experiences]. This condition has been associated with reductions in nutritional outcomes [@bhattacharya2004poverty; @kirkpatrick2008food; @olson1999nutrition] and physical and mental health in children and adults [@elgar2021relative; @jones2017food; @ramsey2011food; @seligman2010food; @stuff2004household]. Over at least the past four decades food banks have become an essential line of defense against food insecurity in Canadian communities [@riches2002food; @holmes2018nothing; @black2020examining; @tarasuk2020relationship]. In this respect, Canada is not unlike numerous other wealthy countries where a systematic dismantling of the welfare state took place in the intervening period [@tarasuk2014food]. 

The emergence of COVID-19, the worst public health crisis since the 1918 flu pandemic, has revealed important social and economic fault lines, and pre-existing patterns of inequality appear to have been exacerbated. Along several other dimensions of stress [e.g., accessibility to health care facilities, @pereira2021geographic], this seems to be the case for food insecurity as well [@laborde2020poverty]. In the US, for example, it has been estimated that there was an increase of more than 30\% in household food insecurity, and more than one third of households were discovered to be newly food insecure - meaning they did not experience food insecurity before the pandemic [@niles2020early]. In Canada, Men and Tarasuk [-@men2021food] report that about 25\% of individuals who experienced job insecurity (a relatively common occurrence during the pandemic), also experienced food insecurity. Similarly, according to Statistics Canada [-@statisticscanada2020food], in the early stages of the pandemic almost 15\% of individuals reported living in a household that faced food insecurity; the risk of food insecurity was substantially higher for households with children. The difference between households with and without children was significant, and 11.7\% of households with children indicated that "food didn’t last and [there was] no money to get more" sometimes or often, compared to 7.3\% of households without children; likewise, 13\% of households with children indicated that they "[c]ouldn’t afford balanced meals" sometimes or often, compared to 8.8\% of households without children.

The impacts of food insecurity during the pandemic are alarming, since diet-related diseases, such as obesity, heart-disease, and diabetes, were already critical public health concerns in Canada prior to COVID-19 [@boucher2017ontario]. While food banks are not necessarily a stable solution to food insecurity and in fact may encourage a retrenchment of neoliberal policy [@wakefield2013sweet], at least they can be argued to provide a resource of last instance to households in precarious situations [@bazerghi2016role]. As recently as 2019, the Hamilton Hunger Report^[https://www.hamiltonfoodshare.org/wp-content/uploads/Hamilton-Food-Share-Hunger-Report-2019.pdf] noted that food banks in Hamilton, Ontario, recorded the highest number of visitors in the past 29 years; the number of children visiting food banks (minors up to 18 years old) was 9,125 in March 2019, up from 8,278 the year before, a rate of increase greater than population growth. 

It is known that urban food environments, within which people make their daily food choices, are essential in influencing eating behaviours and health outcomes, based on factors such as food availability, ease of geographic accessibility and socio-demographic variations [@paez2010relative; @vanderlee2017food; @widener2018spatial]. However, while there is a wealth of literature that has examined the topic of geographic accessibility to healthy food through the "food desert" concept, there has been little research into accessibility to food banks. Although previous work has explored differences in _accessing_ food banks, such as how some households utilize food banks over short periods of time while others regularly utilize food banks as longer-term resource [e.g., @enns2020experiences], we are not aware of any research that has focused on the geographic component of accessibility.

The study of place-based geographic accessibility is concerned with capturing the potential to reach destinations of value using the transportation network [@paez2012measuring]. Indeed, the Government of Canada's recent Food Policy has made "access" to healthy food a priority for Canadian communities^[https://www.agr.gc.ca/eng/about-our-department/key-departmental-initiatives/food-policy/the-food-policy-for-canada/?id=1597863791042] and previous survey research has suggested that such accessibility plays a key role in user satisfaction with food bank service delivery [@holmes2018nothing]. However, as with research into the prevalence of food deserts, accessibility to food banks is unlikely to be evenly distributed, and variation throughout a city can be expected due to transportation network characteristics, and the spatial distribution of food bank locations and the population they are meant to serve. Furthermore, policy responses to the COVID-19 pandemic likely have added to the distress of vulnerable households. Non-pharmaceutical interventions during the pandemic involving restrictions in mobility have increased the friction of travel, in particular by transit on which low income populations are more reliant [e.g., @deweese2020tale]. At the same time, the pandemic has created additional stress for the operators of food banks through disruptions in the supply chain [e.g., @mckay2021exploring] as well as concerns surrounding the delivery of service in safe conditions and possible cancellation of food service programs.

For this study, we aim to look at how the landscape of food banks and related services (e.g. low-cost or free meal service providers) available in Hamilton, Ontario, changed during the pandemic. Did the number of open food bank services diminish? If so, what was the accessibility to food banks before the pandemic from the perspective of low income households, and how it changed during the pandemic? And finally, who are most likely to have been impacted by changes in the accessibility landscape? This paper first looks at the distribution of food banks and related services before and during the pandemic. Then, we use the balanced floating catchment area approach of Paez et al. [-@paez2019demand] to investigate the accessibility situation. For this, we use a fully disaggregated approach based on parcel-level data. Socio-economic and demographic data are drawn from the latest Census of Canada (2016), whereas travel information is from the most recent regional travel survey from 2016. This paper follows reproducible research recommendations [see @brunsdon2020opening], and the research was conducted using open source tools for transportation analysis [@lovelace2021open]. The code and data necessary to reproduce the analysis are available in a public repository^[add repository]. 

Food Insecurity and Food Bank Use in Canada
============

Food insecurity is the inability to acquire and consume an adequate amount or good quality food, leading to inadequate nutrient intake [@enns2020experiences; @kirkpatrick2008food; @tarasuk2009household]. This nutrient deficiency is associated with major population health concerns, particularly among Canadians at socio-economic disadvantage [@bazerghi2016role]. Data on food insecurity in Canada is collected in several ways. Quantitatively, official government surveys such as the Household Food Security Survey Module (HFSSM), the Canadian Community Health Surveys (CCHS), the International Study of Adults (LISA), and official classifications determined by Health Canada in relation to socio-demographic variables offer some insight into food insecurity [@kirkpatrick2008food; @tarasuk2009household; @gundersen2018food]. Nationally, it has been found that food insecurity impacts approximately 12.3% of Canadian households [@tarasuk2014food]

Food banks - sometimes also referred to as ‘food pantries’ and ‘food shelves’ - originated as a community response to aid those with inadequate food by voluntarily offering them meals and ingredients [@riches2002food; @loopstra2012relationship]. The scope and objectives of food banks can vary by region and by country, and these organizations can include not only prepared meals and aliments, but also shared spaces to connect in community gardens and community kitchens [@wakefield2013sweet]. Although in their origin food banks were meant to be provide a temporary solution to accommodate those in hunger due to job retrenchments and economic downfalls since the 1980s, over time they have evolved into a community practice to secure emergency food supplies for those in need [@loopstra2012relationship; @wakefield2013sweet]. 

In Canada, the number of food banks has steadily increased in the past few decades [@wakefield2013sweet]. The largest database of food banks and their use comes from the non-profit association Food Banks Canada (FBC), which conducts an annual assessment through its affiliated members. FBC's 2018 Hunger Count report^[https://foodbankscanada.ca/getmedia/241fb659-05f5-44a2-9cef-56f5f51db523/HungerCount-2018_FINAL_EN.pdf.aspx?ext=.pdf] (the most recent available) listed 1,830 member food banks across the country, and found that Canadians visited food banks 1.1 million times in March of 2018. Of those accessing food banks, certain population characteristics tend to be over-represented compared to national totals from the 2016 Canadian Census of Population. According to FBC's 2018 data, single-adult households represent 45% of those utilizing food banks despite making up 28% of Canada's population, 19% are single-parent households (compared to 10% nationally), and 35% of those accessing food bank services are children aged 0-18 even though their share of Canada's national population is approximately 20%. In addition, 59% of households accessing food banks list social or disability assistance as their primary source of income. Similarly, using data from the 2011-2012 CCHS, Tarasuk et al. [-@tarasuk2019geographic] found higher odds of food insecurity amongst households relying on social assistance, those without a university degree or with children under the age of 18, and individuals that lived alone, renters, and those identifying as Aboriginal. While surveys revealed that only 20 to 30 percent of those experiencing food insecurity were found to frequent food banks in Canada [@tarasuk2014food], research from Ottawa [@enns2020experiences] and Vancouver [@black2020examining] suggests that long-term users tend to be older, have health or mobility challenges, live in large households, and are less likely to have employment income.

Economic stress caused by the COVID-19 pandemic, rising unemployment rates, and changes in poverty levels have disrupted the food environment and led to higher rates of food insecurity [@niles2020early]. Pandemic-related food security studies in the US have found a substantial increase in households experiencing food insecurity for the first time, and also in households experiencing more severe food insecurity than before [@niles2020early; @wolfson2020food]. Most recently in May 2020, Canada recorded 14.7% of its population living in food insecurity in the past 30 days [@statisticscanada2020food]. Considering the negative mental and physical health effects associated with food insecurity, increases in food insecurity rates due to the pandemic, signal a change in the food environment with potential damages to population health during the course of the pandemic and beyond [@niles2020early]. Recent data^[https://www.foodbankscanada.ca/FoodBanks/MediaLibrary/COVID-Report_2020/A-Snapshot-of-Food-Banks-in-Canada-and-the-COVID-19-Crisis_Exec-Sum_EN.pdf] from FBC showed that 52% of member food banks reported an increase in usage in March of 2020 when initial lockdown restrictions were put in place across much of the country. The pandemic also created significant staffing issues with 42% of food banks reporting a reduction in volunteers. However, 53% of food banks later reported a decrease in use into the summer of 2020 which FBC members attributed to emergency financial support programs from the federal government. Nevertheless, some of these benefit programs were temporary, which suggests that many households may again turn to food bank services to meet their needs.

In terms of geography, previous research conducted at the provincial scale using data from the 2011-2012 CCHS found that the prevalence of food insecurity ranged across the country from 11.8% of households in Ontario to 41% of households in Nunavut [@tarasuk2019geographic]. However, although previous research has examined the characteristics of individuals and households accessing food banks, the locational or transportation accessibility aspect of food bank access is not well understood. A wealth of literature examining the food desert concept suggests that, in addition to socio-economic and demographic factors, location and transportation networks play a key role in a household's accessibility to healthy foods [@paez2010relative; @vanderlee2017food; @widener2018spatial]. For food banks specifically, previous qualitative research by Smith et al. [-@smith2017food] in Ontario has noted that participants access food banks using a variety of modes of transportation and that some food bank users have expressed difficulties with transportation for trips to food bank locations, with one respondent stating "I wish it [the food bank] was a little more centrally located. Because if I didn’t have a bike I’d have to walk it all the way out there and back. I wonder about people who don’t." From this, the authors conclude that "transportation can be challenging, particularly if the food bank is situated in a remote location." To offer greater insight into the role of transportation and location in food bank accessibility, this research examines how geographic accessibility to food banks and food services changed in Hamilton during the COVID-19 pandemic.

Methods and Materials
===================

## Methods

For the research in this paper we adopt the balanced floating catchment area approach of Paez et al. [-@paez2019demand]. This method for estimating accessibility is a form of the widely-used two-stage floating catchment area method [@radke2000spatial; @luo2003measures]. Floating catchment areas are used to estimate accessibility when there are potential congestion effects, and operate by calculating first the _demand_ for spatially distributed services. The demand (usually the number of people who require a service) is used to calculate a level of service. In a second step, the level of service is allocated back to the population. Demand and level of service are allocated using some form of distance-decay to embody the geographical principle that, given a choice, people prefer to travel less than more when reaching destinations.

More formally, the first step of this method is as follows:
$$
L_j = \frac{S_j}{\sum_{i=1}^nP_iw_{ij}}
$$

\noindent where $S_j$ is the level of supply at location $j$, in simplest terms whether a service point is present (i.e., $S_j=1$) or not (i.e., $S_j=0$); $P_i$ is the population at location $i$ that demands the service; and $w_{ij}$ is a weight, typically a function of the distance between locations $i$ and $j$. $L_j$ is the level of service at location $j$ and it is the inverse of the number of people that need to be serviced.

The second step in this process is then summing the level of service that each population unit can reach, according to the distance-decay weight:
$$
A_i = \sum_{j=1}^JL_jw_{ji}
$$

\noindent where $A_i$ is the accessibility to the service, which is in the same units as the level of service: as the inverse of the population being serviced. When the population being serviced is low accessibility is high (i.e., there is little competition for the service), and viceversa. 

Floating catchment area methods are prone to overestimation of the population and the level of service due to multiple-counting. The population at $P_i$ is allocated to _every_ service point $j$ for which $w_{ij}>0$. Similarly, the level of service at $LOS_j$ is allocated to _every_ population point for which $w_{ji}>0$. This inflation effect has been known for several years, and several modifications have been proposed to mitigate it [e.g., @wan2012three; @delamater2013spatial]. A definitive solution to this issue was presented by Paez et al. [-@paez2019demand]. In order to avoid the multiple-counting in the summations, the population and the level of service need to be allocated _proportionally_. This is achieved by standardizing the weights as follows:
$$
w_{ij}^\text{st} = \frac{w_{ij}}{\sum_{i=1}^nw_{ij}}
$$
\noindent and:
$$
w_{ji}^\text{st} = \frac{w_{ji}}{\sum_{j=1}^Jw_{ji}}
$$

The standardized weights satisfy the following conditions:
$$
\sum_{i=1}^nw_{ij}^\text{st}=1
$$

\noindent and:
$$
\sum_{j=1}^Jw_{ji}^\text{st}=1
$$

Since the population is allocated proportionally, its value is preserved:
$$
\sum_{i=1}^nP_iw_{ij}^\text{st}=P_i
$$

\noindent as is the level of service:
$$
\sum_{j=1}^JL_jw_{ji}^\text{st}=L_j
$$

## Data

Data have been prepared for sharing as a data package^[add repository]. The contents of the data package are described next.

### Statistics Canada

Population and income statistics for 2016 were retrieved at the level of Dissemination Areas (DAs) using the package `cancensus` [@vonBergmann2021cancensus]. DAs are the smallest publicly available census geography in Canada. Income data corresponds to the count of households by different total income groupings.

### Origins: Residential parcels

We converted all recorded residential land parcels in the City of Hamilton to points on the road network. Each point includes information about the number of residential units in the parcel. Next, we define low-income households as those having a total income of less than CAD40,000, which is approximately the mid-point of the low income cut-off (LICOs) for families in Canadian cities with populations greater than 500,000 in 2016, to match other Census data [@statisticscanada2020licos]. We then "populate" each residential unit with the probability of being a low-income household based on the counts of households by income groups in the DA in which the parcel is located. While this method assumes a constant probability of low-income household status for all residential units in a DA, the parcel-level analysis affords a high level of spatial disaggregation for the accessibility analysis.

### Destinations: Food Banks and Food Service Locations

The locations of food banks and related food services were obtained from the Hamilton Public Library's Food Access Guide^[http://foodaccessguide.ca/sites/default/files/partnersites/pdf/foodaccessguide.pdf]. The guide was updated in April of 2021 to indicate any change affected on the services due to the pandemic. This includes modified business hours, a need to make reservations before frequenting, and locations that have completely shut down in consequence. While some food bank services have a specific a target population, such as prioritizing family with young children aged between 0 and 3 or accepting only those providing proof of low-income status through housing and utility statements, all the food bank services indicated below are designed to accommodate those in need of food at zero to low cost. With our focus on food banks and food services that offer free or low-cost meals at particular locations, we first removed services such as Meals on Wheels and other food access services such as food box, community kitchens, student nutrition programs, and shopping and transportation. In addition, two free meal services held on different days at the same location were collapsed into a single service point for the accessibility analysis. 

```{r table-food-bank-info, echo=FALSE, results='asis'}
foodbank_table %>% kable("latex",
        booktabs = TRUE,
        align = ("cccccc"),
        col.names = c("Type", 
                      "Description", 
                      "Locations Pre-COVID", 
                      "Locations During COVID", 
                      "Additional Notes"),
        caption = "\\label{tab:food-bank-info}foodbank and Food Service Information.",
        escape = FALSE) %>%
  kable_styling(latex_options = c("striped", "scale_down")) %>%
  column_spec(2, width = "15em") %>%
  column_spec(5, width = "15em")
```

### Routing and travel time tables

Travel time tables for three modes (car, transit, walking) were computed using the parcels as the origins and the locations of the food banks as the destinations. For routing, the package `r5r` [@pereira2021r5r] was used with a network extract for the City of Hamilton from OpenStreetMaps and the General Transit Feed Specification from Hamilton Street Railway, the local transit operator. For routing purposes we used maximum values of 180 min and 10,000 m walking distance: any destination that exceeded these thresholds was ignored. The departure time used for routing was **TIME**.

### Transportation Tomorrow Survey

We used the Data Retrieval System of the Transportation Tomorrow Survey (TTS)\footnote{\url{http://dmg.utoronto.ca/}} to download cross-tabulations of: 1) primary mode of travel per trip by income by place of residence; and 2) age by income by place of residence. These data are from the 2016 Survey (the most recent available), and data are geocoded at the level of Traffic Analysis Zones (TAZ) using the most recent zoning system from 2006. Each parcel point is populated with the proportion of trips by three modes of travel: car (as driver or passenger), transit, and walk.

### Expected Travel Times

Once we obtained travel time tables with population (number of households) and proportion of trips by mode, we calculated the expected travel time $ett$ from each parcel $i$ to a food bank or food service location $j$ as follows:
$$
ett_{ij} = p^c_i\cdot tt^c_{ij} + p^t_i\cdot tt^t_{ij} + p^w_i\cdot tt^w_{ij}
$$

\noindent where $p^k_i$ is the proportion of trips by mode $k$ in the TAZ of parcel $i$, and $tt^k_{ij}$ is the travel time from parcel $i$ to the food bank. In other words, the expected travel time is the weighted sum of travel times to the food bank, with the weights given by the expected modal split in the TAZ.

Results and Discussion
===================

```{r accessibility-threshold-sensitivity, include=FALSE}
## Analysis
# Testing different thresholds to check how accessibility changes. Here, the thresholds are varied from 2 min to 30 min in 2 min step increments
threshold_seq <- seq(from = 2, to = 30, by = 2)

# Initialize a data frame to store results
accessibility_test <- data.frame(threshold = threshold_seq, 
                                 accessibility = numeric(length(threshold_seq)))

# Calculate the system-wide accessibility according to each threshold
for(i in 1:length(threshold_seq)){
  results_test <-  ttm %>% 
  transmute(UID, OBJECTID, travel_time = e_travel_time, population = income_less40k, supply = 1) %>%
    b2sfca(threshold = i )
  accessibility_test$accessibility[i] <- sum(results_test$accessibility$accessibility)
}
```

```{r results-pre-covid, include=FALSE}
## Analysis 
# Calculate k-min accessibility pre-covid:
results_pre <- ttm %>%
  #dplyr::filter(COVIDClose == "No") %>%
  transmute(UID, 
            OBJECTID, 
            travel_time = e_travel_time, 
            population = income_less40k, 
            supply = 1) %>%
  b2sfca(threshold = 15)
```

```{r results-during-covid, include=FALSE}
## Analysis 
# Calculate k-min accessibility during covid:
results_covid <- ttm %>%
  dplyr::filter(COVIDClose == "No") %>%
  transmute(UID, 
            OBJECTID, 
            travel_time = e_travel_time, 
            population = income_less40k, 
            supply = 1) %>%
  b2sfca(threshold = 15)
```

```{r, bind-accessibility-results, include=FALSE}
## Analysis
# Bind level of service results:
los <- rbind(data.frame(results_pre$los, 
                        timing = "Pre-covid", 
                        threshold = "30 min"),
             data.frame(results_covid$los, 
                        timing = "During covid", 
                        threshold = "30 min")) %>%
  mutate(timing = factor(timing, 
                         levels = c("Pre-covid", 
                                    "During covid"),
                         ordered = TRUE))

# Bind accessibility results:
accessibility <- rbind(data.frame(results_pre$accessibility, 
                                  timing = "Pre-covid", 
                                  threshold = "30 min"),
                       data.frame(results_covid$accessibility, 
                                  timing = "During covid", 
                                  threshold = "30 min")) %>%
  mutate(timing = factor(timing, 
                         levels = c("Pre-covid", 
                                    "During covid"),
                         ordered = TRUE))
```

Figure \ref{fig:foodbanks} shows the location of food banks in the City of Hamilton and their status. Before the pandemic there were `r nrow(foodbank_locations)` of which `r nrow(foodbank_locations %>% filter(COVIDClose == "Yes"))` (`r round(nrow(foodbank_locations %>% filter(COVIDClose == "Yes"))/nrow(foodbank_locations) * 100, 2)`\%) closed during the pandemic. As shown in the figure, food banks tend to be predominantly located in the central parts of the city. This is not surprising: population density is high there, and it is also the part of the city where lower income households are more numerous in absolute and relative terms (see Figure \ref{fig:low-income-households}). Alas, this is also the part of the city where most of the closures during the pandemic happened.

```{r plot-location-foodbanks, echo=FALSE, fig.cap="\\label{fig:foodbanks}Location of foodbanks and operation status; the dotted box is an inset of the central part of the City of Hamilton"}
## Analysis
# Plot location of foodbanks

# Create a bounding box for an inset
inset_box <- st_bbox(c(xmin = -79.975,
          xmax = -79.775, 
          ymax = 43.2, 
          ymin = 43.3), 
        crs = st_crs(4326)) %>%
  st_as_sfc()
  
fb <- ggplot() +
  geom_sf(data = hamilton_cma,
          fill = "lightgray") +
  geom_sf(data = foodbank_locations,
          aes(size = COVIDClose,
              shape = COVIDClose)) +
  geom_sf(data = inset_box,
          linetype = "dotted",
          color = "red",
          fill = NA) +
  scale_shape_manual(name = "Closed during COVID-19",
                     values = c("Yes" = 4, "No" = 1)) +
  scale_size_manual(values = c("Yes" = 3, "No" = 2)) +
  guides(size = FALSE) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "none")

fb_inset <- ggplot() +
  geom_sf(data = hamilton_cma,
          fill = "lightgray") +
  geom_sf(data = foodbank_locations,
          aes(size = COVIDClose,
              shape = COVIDClose)) +
  geom_sf(data = inset_box,
          linetype = "dotted",
          color = "red",
          fill = NA) +
  scale_shape_manual(name = "Closed during COVID-19",
                     values = c("Yes" = 4, "No" = 1)) +
  scale_size_manual(values = c("Yes" = 3, "No" = 2)) +
  xlim(-79.975, -79.775) +
  ylim(43.2, 43.3) +
  guides(size = FALSE) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "bottom")

fb / fb_inset
```

```{r plot-low-income-households, echo=FALSE, fig.cap="\\label{fig:low-income-households}Number and proportion of households with incomes less than CAD40,000."}
lih <- ggplot() +
  geom_sf(data = data_da_2016,
          aes(fill = income_less40k),
          color = NA) +
  geom_sf(data = inset_box,
          linetype = "dotted",
          color = "red",
          fill = NA) +
  scale_fill_viridis_c(name = "Number of households", 
                       option = "A",
                       direction = -1) +
  theme_minimal() +
  theme(axis.text = element_blank(),
        legend.position = "bottom")

p_lih <- ggplot() +
  geom_sf(data = data_da_2016,
          aes(fill = p_inc_less40k),
          color = NA) +
  geom_sf(data = inset_box,
          linetype = "dotted",
          color = "red",
          fill = NA) +
  scale_fill_viridis_c(name = "Proportion of households", 
                       option = "A",
                       direction = -1) +
  theme_minimal() +
  theme(axis.text = element_blank(),
        legend.position = "bottom")

lih / p_lih
```

To implement the accessibility calculations, we must select a distance-decay function. In this task we find limited support in the literature, which is mostly silent on the travel patterns of people who visit food banks. For this reason, we opt for a simple cumulative opportunities function as follows:
$$
w_{ij}=w_{ji}=
\begin{cases}
1 & \text{ if } ett_{ij}\le \delta\\
0 & \text{ otherwise}
\end{cases}
$$
\noindent where $ett_{ij}$ is the multimodal expected travel time as described previously, and $\delta$ is a travel threshold. When the expected travel time exceeds this threshold, a facility is no longer considered accessible. Further, the weights are standardized for the balanced floating catchment area approach. 

Figure \ref{fig:sensitivity-analysis} shows the results of conducting sensitivity analysis of the system-wide accessibility as we vary the threshold (considering the situation before the pandemic). There is a clear pattern whereby more strict values of $\delta$ are associated with higher levels of system-wide accessibility: while increases in accessibility that result from decreases in the travel time window might seem counter-intuitive, this is a result of lower _congestion_, since fewer households are serviced and are thus competing for the same resources. System-wide accessibility declines with higher values of $\delta$: as more households are serviced, congestion grows and the level of service declines, although this happens at a declining rate. We are not aware of any standards that explain how long people are expected to travel for food banks, but we note that in developing countries, access to drinking water is defined as a source that takes less than 30 minutes to reach [round trip, see @world2019progress]. There is no reason why people in affluent countries should be expected to travel more for a basic need such as food. Accordingly, we adopt a threshold of 15 minutes for the analysis (representing a one-way trip). 

```{r plot-results-sensitivity-analysis, out.width="60%", echo=FALSE, fig.cap="\\label{fig:sensitivity-analysis}Accessibility as a function of threshold"}
acc_sensitivity <- ggplot(accessibility_test, 
       aes(x = threshold, y = accessibility)) +
  geom_line() +
  ylab("Accessibility") +
  xlab("Threshold (in min)") +
  theme_minimal()

acc_sensitivity
```

Using this threshold, we find that the system-wide accessibility (interpreted as a provider-to-population ratio) was `r round(sum(results_pre$accessibility$accessibility), 3)` (food banks and food service locations per low income household in the city) before COVID-19, but declined to `r round(sum(results_covid$accessibility$accessibility), 3)` during the pandemic. It is striking that although almost `r round((1 - nrow(foodbank_locations %>% filter(COVIDClose == "Yes"))/nrow(foodbank_locations)) * 100)`\% of food banks remained in operation during the pandemic, there was a loss of accessibility greater than `r abs(round((sum(results_covid$accessibility$accessibility) - sum(results_pre$accessibility$accessibility))/sum(results_pre$accessibility$accessibility) * 100))`\%, suggesting the location of food banks and food services plays an important role in serving those in need.

```{r join-zonal-ids-to-accessibility-table, include=FALSE}
## Analysis
# Join zonal identifiers to accessibility results:
accessibility <- accessibility %>%
  left_join(dwelling_network_points_2016 %>%
            st_drop_geometry() %>%
              dplyr::select(ID,
                            DAUID,
                            TAZUID,
                            children,
                            adults,
                            seniors),
            by = c("UID" = "ID")) %>%
  left_join(population_age_income %>%
              st_drop_geometry() %>%
              transmute(TAZUID),
            by = "TAZUID") 
```  

```{r, join-geometry-to-level-of-service, include=FALSE}
## Analysis 
# Join geometry:
los <- los %>%
  left_join(foodbank_locations %>%
              dplyr::select(ID),
            by = c("OBJECTID" = "ID")) %>%
  st_as_sf()
```

Turning to the individual food bank and food service locations, the levels of service offered before and during the pandemic are shown in Figure \ref{fig:levels-of-service}. The level of service is functionally the inverse (because each food bank has a "capacity" of 1) of the number of low-income households in the travel-mode weighted travel time catchment area of the food banks. Higher values mean that a facility is expected to service fewer households. Conversely, lower values indicate grater congestion. 

The general pattern of the levels of service is similar before and during the pandemic, with lower values in the center of the city. Three more peripheral facilities towards the south of the city also have lower levels of service, presumably because they are meant to service a relatively large suburban/exurban population. During the pandemic, however, the levels of service dropped, in some cases quite substantially. The pattern of the losses in level of service, moreover, is not uniform. The upper pane of Figure \ref{fig:levels-of-service-changes} shows that the three peripheral facilities in the southern suburban/exurban part of the city had low levels of service to begin with, but did not see major declines during the pandemic. Turning to the inset map, levels of service deteriorated more in the central part of the city. However, the loss of level of service was not as large in the core (where most of the food banks are), but more marked in the inner ring around the core where facilities may have faced greater demand from both central city and suburban populations after the closure of food banks during the pandemic.

```{r plot-levels-of-service, echo=FALSE, fig.cap="\\label{fig:levels-of-service}Levels of service at each facility pre-COVID-19 (top panel) and during COVID-19 (bottom panel)."}
## Analysis
# Plot levels of service before and during covid

# Pre-covid
los_pre <- ggplot() +
  geom_sf(data = hamilton_cma) +
  geom_sf(data = los %>%
            filter(timing == "Pre-covid"),
          aes(color = los,
              size = los),
          alpha = 0.5) +
  geom_sf(data = foodbank_locations,
          aes(shape = COVIDClose)) +
  scale_color_viridis_c(name = "Level of service \npre-COVID-19",
                        option =  "A", 
                        direction = -1,
                       breaks = c(0.0005,
                                  0.0010,
                                  0.0015,
                                  0.0020,
                                  0.0025),
                       labels = c("0.00050",
                                  "0.00100",
                                  "0.00150",
                                  "0.00200",
                                  "0.00250")) +
  scale_shape_manual(values = c("Yes" = 4, "No" = 1)) +
  guides(size = FALSE, shape = FALSE) +
  theme_minimal() +
  theme(axis.text = element_blank(),
        legend.position = "right")

# During covid
los_covid <- ggplot() +
  geom_sf(data = hamilton_cma) +
  geom_sf(data = los %>%
            filter(timing == "During covid"),
          aes(color = los,
              size = los),
          alpha = 0.5) +
  geom_sf(data = foodbank_locations,
          aes(shape = COVIDClose)) +
  scale_color_viridis_c(name = "Level of service \nduring COVID-19",
                        option =  "A", 
                        direction = -1,
                       breaks = c(0.00050,
                                  0.00075,
                                  0.00100,
                                  0.00125,
                                  0.00150),
                       labels = c("0.00050",
                                  "0.00075",
                                  "0.00100",
                                  "0.00125",
                                  "0.00150")) +
  scale_shape_manual(values = c("Yes" = 4, "No" = 1)) +
  guides(size = FALSE, shape = FALSE) +
  theme_minimal() +
  theme(axis.text = element_blank(),
        legend.position = "right")

los_pre / los_covid
```

```{r plot-levels-of-service-changes, echo=FALSE, fig.cap="\\label{fig:levels-of-service-changes}Changes in levels of service at each facility from pre-COVID-19 to during COVID-19."}
# This figure shows the places where the level of service deteriorated most (excluding the places that closed, where it vanished).
los_change <- los %>%
  st_drop_geometry() %>%
  pivot_wider(names_from = timing, 
              values_from = los, 
              values_fill = 0) %>%
  filter(`During covid` > 0) %>%
  mutate(los_d = `During covid` - `Pre-covid`) %>%
  left_join(foodbank_locations %>%
            transmute(OBJECTID = ID,
                      geometry),
          by = "OBJECTID") %>%
  st_as_sf()

lc <- ggplot() +
  geom_sf(data = hamilton_cma) +
  geom_sf(data = los_change, 
          aes(color = los_d,
              size = los_d),
          alpha = 0.3) +
  geom_sf(data = foodbank_locations,
          aes(shape = COVIDClose)) +
  geom_sf(data = inset_box,
          linetype = "dotted",
          color = "red",
          fill = NA) +
  scale_color_viridis_c(name = "Change in level of service",
                        option =  "A", 
                        direction = 1,
                       breaks = c(-0.0001,
                                  -0.0002,
                                  -0.0003,
                                  -0.0004,
                                  -0.0005),
                       labels = c("-0.0001",
                                  "-0.0002",
                                  "-0.0003",
                                  "-0.0004",
                                  "-0.0005")) +
  scale_size(trans = 'reverse') +
  scale_shape_manual(values = c("Yes" = 4, "No" = 1)) +
  guides(size = FALSE, shape = FALSE) +
  theme_minimal() +
  theme(axis.text = element_blank(),
        legend.position = "none")

lc_inset <- ggplot() +
  geom_sf(data = hamilton_cma) +
  geom_sf(data = los_change, 
          aes(color = los_d,
              size = los_d),
          alpha = 0.7) +
  geom_sf(data = foodbank_locations,
          aes(shape = COVIDClose)) +
  geom_sf(data = inset_box,
          linetype = "dotted",
          color = "red",
          fill = NA) +
  scale_color_viridis_c(name = "Change in level of service",
                        option =  "A", 
                        direction = 1,
                       breaks = c(-0.0001,
                                  -0.0002,
                                  -0.0003,
                                  -0.0004,
                                  -0.0005),
                       labels = c("-0.0001",
                                  "-0.0002",
                                  "-0.0003",
                                  "-0.0004",
                                  "-0.0005")) +
  scale_size(name = "Change in level of service",
                        trans = 'reverse',
                       breaks = c(-0.0001,
                                  -0.0002,
                                  -0.0003,
                                  -0.0004,
                                  -0.0005),
                       labels = c("-0.0001",
                                  "-0.0002",
                                  "-0.0003",
                                  "-0.0004",
                                  "-0.0005")) +
  scale_shape_manual(values = c("Yes" = 4, "No" = 1)) +
  xlim(-79.975, -79.775) +
  ylim(43.2, 43.3) +
  guides(color = guide_legend(title.position = "top"), 
         #size = FALSE, 
         shape = FALSE) +
  theme_minimal() +
  theme(axis.text = element_blank(),
        legend.position = "bottom")

lc / lc_inset
```

To further elucidate this issue, we now turn to the results of the accessibility analysis. The top pane of Figure \ref{fig:accessibility} reveals that, compared with the outer rural zones, the smaller more urban zones of the city generally exhibit higher accessibility to food banks and food service locations. However, the pattern is not particularly smooth - this is largely attributable to the travel-mode weighting of travel times according to the trip patterns of low-income household respondents to the TTS. For example, in zones where low-income households make a high proportion of trips by walking, access to food bank locations by walking is afforded a concomitantly high weight in our calculations of travel time compared to transit or car travel. From this, highly-accessible locations result from a mix of characteristics: low-income households in locations where travel options that align with zonal modal split are available to connect them to food bank locations with high levels of service within 15 minutes.

```{r aggregate-accessibility-by-taz, include=FALSE}  
## Analysis
# Accessibility by TAZ:
accessibility_taz <- accessibility %>%
  group_by(TAZUID, 
           timing) %>%
  summarize(accessibility = sum(accessibility),
            timing = first(timing),
            .groups = "drop") %>%
  left_join(population_age_income %>%
              transmute(TAZUID,
                        children,
                        adults,
                        seniors),
            by = "TAZUID") %>%
  st_as_sf()
```

```{r plot-accessibility, echo=FALSE, fig.align = 'center', fig.cap="\\label{fig:accessibility}Accessibility by traffic analysis zone pre-COVID-19 (top panel) and during COVID-19 (bottom panel)."}
## Analysis
# Plot accessibility before and during covid:
acc_pre <- ggplot() +
  #geom_sf(data = hamilton_cma) +
  geom_sf(data = accessibility_taz %>%
            filter(timing == "Pre-covid"),
          aes(fill = accessibility)) +
  scale_fill_viridis_c(name = "Accessibility \npre-COVID-19",
                        option =  "A", 
                        direction = -1,
                       breaks = c(0.002,
                                  0.0016,
                                  0.0012,
                                  0.0008,
                                  0.0004),
                       labels = c("0.0020",
                                  "0.0016",
                                  "0.0012",
                                  "0.0008",
                                  "0.0004")) +
  theme_minimal() +
  theme(axis.text = element_blank(),
        legend.position = "right")

acc_covid <- ggplot() +
  #geom_sf(data = hamilton_cma) +
  geom_sf(data = accessibility_taz %>%
            filter(timing == "During covid"),
          aes(fill = accessibility)) +
  scale_fill_viridis_c(name = "Accessibility \nduring COVID-19",
                        option =  "A", 
                        direction = -1,
                       breaks = c(0.0010,
                                  0.0008,
                                  0.0006,
                                  0.0004,
                                  0.0002),
                       labels = c("0.0010",
                                  "0.0008",
                                  "0.0006",
                                  "0.0004",
                                  "0.0002")) +
  theme_minimal() +
  theme(axis.text = element_blank(),
        legend.position = "right")

acc_pre / acc_covid
```

```{r plot-accessibility-changes, echo=FALSE, fig.align = 'center', fig.cap="\\label{fig:accessibility-changes}Changes in accessibility from pre-COVID-19 to during COVID-19."}
## Analysis
# Calculate accessibility change by TAZ:
accessibilty_taz_change <- accessibility_taz %>%
  st_drop_geometry() %>%
  pivot_wider(names_from = timing, 
              values_from = accessibility) %>%
  # Calculate changes in accessibility
  mutate(acc_d = `During covid` - `Pre-covid`) %>%
  # Join TAZ geometry
  left_join(population_age_income %>%
            transmute(TAZUID,
                      geometry),
          by = "TAZUID") %>%
  # Convert to simple features
  st_as_sf()

# Plot
acc_change <- ggplot() +
  #geom_sf(data = hamilton_cma) +
  geom_sf(data = accessibilty_taz_change,
          aes(fill = acc_d),
          color = NA) +
  geom_sf(data = population_age_income,
          fill = NA) +
  geom_sf(data = inset_box,
          linetype = "dotted",
          color = "red",
          fill = NA) +
  scale_fill_viridis_c(name = "Change in accessibility",
                        option =  "A", 
                        direction = 1,
                       breaks = c(-0.0008,
                                  -0.0006,
                                  -0.0004,
                                  -0.0002),
                       labels = c("-0.0008",
                                  "-0.0006",
                                  "-0.0004",
                                  "-0.0002")) +
  theme_minimal() +
  theme(axis.text = element_blank(),
        legend.position = "none")

acc_change_inset <- ggplot() +
  geom_sf(data = accessibilty_taz_change %>%
            st_transform(crs = 4326),
          aes(fill = acc_d)) +
  geom_sf(data = inset_box,
          linetype = "dotted",
          color = "red",
          fill = NA) +
  scale_fill_viridis_c(name = "Change in accessibility",
                        option =  "A", 
                        direction = 1,
                       breaks = c(-0.0008,
                                  -0.0006,
                                  -0.0004,
                                  -0.0002),
                       labels = c("-0.0008",
                                  "-0.0006",
                                  "-0.0004",
                                  "-0.0002")) +
  guides(fill = guide_legend(title.position = "top")) +
  xlim(-79.975, -79.775) +
  ylim(43.2, 43.3) +
  theme_minimal() +
  theme(axis.text = element_blank(),
        legend.position = "bottom")

acc_change / acc_change_inset
```
```{r accessibility-change-by-parcel, include=FALSE}
## Analysis
# Calculate accessibility change by parcel:
accessibility_change <- accessibility %>%
  select(UID, timing, accessibility) %>%
  pivot_wider(names_from = timing, 
              values_from = accessibility,
              values_fill = 0) %>%
  # Calculate changes in accessibility
  mutate(acc_d = `During covid` - `Pre-covid`)
```

```{r join-accessibility-change-to-table, include=FALSE}
## Analysis
# Join accessibility change to accessibility table:
accessibility <- accessibility %>%
  left_join(accessibility_change %>%
              select(UID, acc_d),
            by = "UID")
```

```{r quartiles-of-accessibility-change, include=FALSE}
## Analysis
# Quartiles of accessibility change:
acc_quintiles_change <- quantile(accessibility_change$acc_d,
                              c(0, 0.25, 0.5, 0.75, 1))
```

```{r accessibility-change-labels, include=FALSE}
## Analysis
# Add labels of accessibility loss to table:
accessibility <- accessibility %>%
  mutate(accessibility_level = case_when(acc_d <= acc_quintiles_change[2] ~ "Bottom 25%",
                                         acc_d > acc_quintiles_change[2] & acc_d <= acc_quintiles_change[3] ~ "Third 25%",
                                         acc_d > acc_quintiles_change[3] & acc_d <= acc_quintiles_change[4] ~ "Second 25%",
                                         acc_d > acc_quintiles_change[4] ~ "Top 25%"),
           accessibility_level = factor(accessibility_level,
                                        levels = c("Top 25%", "Second 25%", "Third 25%", "Bottom 25%"),
                                        ordered = TRUE))
```

```{r aggregate-accessibility-by-age-group, include=FALSE}
## Analysis
# Calculate accessibility by age group and accessibility level:
accessibility_by_age <- accessibility %>%
  group_by(timing, 
           accessibility_level) %>%
  summarize(children = sum(children),
            adults = sum(adults),
            seniors = sum(seniors),
            accessibility = sum(accessibility),
            .groups = "drop")
# The accessibility level is the magnitude of the accessibility loss: the top 25% faced the smallest losses in accessibility, and the bottom 25% faced the greatest losses in accessibility. 
```

Discuss the results of aggregating the accessibility by age group (see Table \ref{tab:accessibility-by-age}). Follow with the analysis of hours of travel?

```{r table-accessibility-by-age-group, echo=FALSE, results='asis'}
cbind(accessibility_by_age %>% 
        filter(timing == "Pre-covid") %>% 
        select(children:accessibility) %>% 
        rename(accessibility_pre = accessibility),
      accessibility_by_age %>% 
        filter(timing == "During covid") %>% 
        transmute(accessibility_covid = accessibility)) %>%
  mutate(children = round(children) %>% 
           prettyNum(big.mark = ","),
         adults = round(adults) %>% 
           prettyNum(big.mark = ","),
         seniors = round(seniors) %>% 
           prettyNum(big.mark = ","),
         change = (accessibility_covid - accessibility_pre) %>% 
           round(5),
         accessibility_pre = round(accessibility_pre, 5),
         accessibility_covid = round(accessibility_covid, 5)) %>%
  kable("latex",
        booktabs = TRUE,
        align = ("cccccc"),
        col.names = c("Children (age $\\le$ 18)", 
                      "Adults (19-64)", 
                      "Seniors (age $\\ge$ 65)", 
                      "Before COVID-19", 
                      "During COVID-19", 
                      "Difference"),
        caption = "\\label{tab:accessibility-by-age}Accessibility by age group among members households with incomes less than CAD40,000.",
        escape = FALSE) %>%
  kable_styling(latex_options = c("striped", "scale_down")) %>%
  add_header_above(c("Population" = 3, "Accessibility" = 3)) %>%
  footnote(general = "Population values have been rounded")
```

Conclusions
===================

Words go here.

References {#references .unnumbered}
==========
